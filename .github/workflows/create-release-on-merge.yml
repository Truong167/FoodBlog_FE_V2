name: Create GitHub Release on Merge

on:
  push:
    branches:
      - dev # Nhánh mà PR Release sẽ được merge vào

jobs:
  create_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Cần quyền để tạo release và tag
      pull-requests: write # Có thể không cần nếu chỉ tạo release, nhưng an toàn để có
      # id-token: write # Thêm nếu bạn dùng OIDC, không thì không cần

    if: contains(github.event.head_commit.message, 'chore(release)')
    # Hoặc nếu bạn có các loại commit message khác cho PR release, bạn có thể điều chỉnh chuỗi tìm kiếm.
    # Tuy nhiên, "chore(release): prepare for v" là một phần của commit message mặc định bạn đang dùng.

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Đảm bảo lấy toàn bộ lịch sử để semantic-release hoặc các công cụ khác hoạt động đúng

      - name: Setup Node & Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.1.4

      - name: Install dependencies
        run: bun install

      - name: Install JQ
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run semantic-release (to create release tag and get release info)
        id: semantic_release_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "--- START: semantic-release execution for release creation ---"
          set -o pipefail
          # Chạy semantic-release. Nếu bạn có @semantic-release/git plugin trong config,
          # nó sẽ tạo tag và release trên GitHub tự động.
          # Nếu bạn chỉ muốn nó xác định version và notes để truyền cho actions/create-release,
          # thì đảm bảo config của bạn không tạo tag hai lần.
          npx semantic-release --debug 2>&1 | tee semantic_release_raw_output.txt || {
            echo "semantic-release command failed with exit code $?."
            cat semantic_release_raw_output.txt
            exit 1
          }
          echo "--- END: semantic-release execution for release creation ---"

          # Trích xuất phiên bản và release notes tương tự như workflow PR
          NEW_VERSION_FROM_CHANGELOG=""
          NEW_VERSION_FROM_CHANGELOG=$(
            grep -E '^##\s(v)?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?\s+\([0-9]{4}-[0-9]{2}-[0-9]{2}\)' CHANGELOG.md |
            head -n 1 |
            sed -E 's/^##\s(v)?([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?)\s+\([0-9]{4}-[0-9]{2}-[0-9]{2}\).*$/\2/'
          )

          RELEASE_NOTES_BODY=$(
              sed -n '/^## '"$NEW_VERSION_FROM_CHANGELOG"'\s/,/^##/P' CHANGELOG.md |
              grep -v '^## ' |
              sed 's/^\s*//;s/\s*$//' |
              awk 'NF {found=1} {if ($0 !~ /^\s*$/) print}'
          )
          if [ -z "$RELEASE_NOTES_BODY" ]; then
              RELEASE_NOTES_BODY="No detailed release notes available."
          fi
          # Không cần escape cho output này nếu nó chỉ dùng cho biến môi trường hoặc output,
          # nhưng nếu dùng cho JSON hoặc truyền trực tiếp vào tham số, vẫn cần cẩn thận.
          # Với actions/create-release, nó có thể xử lý tốt markdown thô.
          # ESCAPED_RELEASE_NOTES_BODY=$(echo "$RELEASE_NOTES_BODY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\n')

          echo "new_version=$NEW_VERSION_FROM_CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "release_notes_pr_body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RELEASE_NOTES_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.semantic_release_run.outputs.new_version != 'none' # Chỉ tạo release nếu có phiên bản mới
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.semantic_release_run.outputs.new_version }}
          release_name: Release v${{ steps.semantic_release_run.outputs.new_version }}
          body: |
            ${{ steps.semantic_release_run.outputs.release_notes_pr_body }}

            Please refer to the [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/v${{ steps.semantic_release_run.outputs.new_version }}/CHANGELOG.md) for full details on this release.
          draft: false
          prerelease: ${{ contains(github.ref, 'dev') || contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
